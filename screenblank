#!/bin/bash
conf=$HOME/.config/screenblank.conf

update_conf() {
	(
		echo -e screenblank=$screenblank
		echo -e autosuspend=$autosuspend
		echo -e autolock=$autolock
		echo -e blank_time='"'$blank_time'"'
		echo -e blanklock_time='"'$blanklock_time'"'
		echo -e lock_time='"'$lock_time'"'
		echo -e suspend_time='"'$suspend_time'"'
	) > $conf
}

set_default_conf() {
	[[ -e $conf ]] && return 1
	screenblank="off"
	autosuspend="on"
	autolock="on"
	blank_time="10"
	blanklock_time=".5"
	lock_time="30"
	suspend_time="60"
	return 0
}

refresh_conf() {
	set_default_conf && {
		screenblank=on
		update_conf
	}
	. $conf
	set_times
}

disable_xset_presets() {
    [[ $(xset -q) = *"yes"* ]] && {
        xset s 0 0
        xset s noblank
        xset s noexpose
        xset dpms 0 0 0
    }
}

clean_exit() {
	screenblank=off
	update_conf
	exit
}

set_times() {
	times=( "$blank_time" "$blanklock_time" "$lock_time" "$suspend_time" )
	[[ "${times[@]}" != "${timeschk[@]}" ]] && {
		unset timesms timeschk
		for i in ${!times[*]}; do
			ms=$(echo "${times[i]}*60000-2000" | bc -l)
			timesms+=(${ms%.*}) timeschk+=(${times[i]})
		done
    }
}

if_video() {
	media=( "youtube\|vimeo\|twitch" "bomi" "mpv" )
	media2=( "Vivaldi\|Chromium" "bomi" "mpv" )
	for i in ${!media[*]}; do
		[[ $(pacmd list-sink-inputs | grep -B12 ${media2[i]}) = *"RUNNING"* ]] || continue
		[[ $(wmctrl -l | grep -i ${media[i]}) ]] && return 0
	done
	return 1
}

resetidle() {
	xdotool mousemove_relative --sync -- 25 25
	xdotool mousemove_relative --sync -- -25 -25
}

ci3() {
	[[ $(pidof i3lock) ]] && return
	IMAGE="/tmp/lockscreen.png"
	scrot $IMAGE
	convert $IMAGE -scale 10% -scale 1000% $IMAGE
	convert $IMAGE -fill black -colorize 25% $IMAGE
	i3lock -i $IMAGE
	rm $IMAGE
	return 0
}

notify() {
	echo "$1"
	[[ $(pidof xfce4-notifyd) ]] && \
	notify-send "$1"
}

status() {
	if_video && \
	vid_playing="playing" || \
	vid_playing="not playing"

	echo -e "screenblank is $screenblank"
	echo -e "AutoLock is $autolock"
	echo -e "AutoSuspend is $autosuspend"
	echo -e "Video is $vid_playing"
	echo -e "-----------------------"
	echo -e "Blank Screen at $blank_time Mins"
	echo -e "Blank LockScreen at $blanklock_time Mins"
	echo -e "Lock at $lock_time Mins"
	echo -e "Suspend at $suspend_time Mins"
}

usage() {
	echo -e "screenblank: DPMS bash script of my personal preference"
    echo -e "\n"
	echo -e "Usage:"
	echo -e "screenblank"
	echo -e "run script without options to toggle on/off"
    echo -e "\n"
	echo -e "screenblank -ts | --toggle_suspend"
	echo -e "toggle AutoSuspend on/off"
    echo -e "\n"
	echo -e "screenblank -tl | --toggle_lock"
	echo -e "toggle AutoLock on/off"
    echo -e "\n"
	echo -e "screenblank -b | --blank"
	echo -e "blank the screen"
    echo -e "\n"
	echo -e "screenblank -l | --lock"
	echo -e "lock the screen with i3lock"
    echo -e "\n"
	echo -e "screenblank -s | --status"
	echo -e "check current configuration"
    echo -e "\n"
	echo -e "screenblank -h | --help"
	echo -e "view usage (this)"
    echo -e "\n"
	echo -e "screenblank -r | --reset"
	echo -e "reset the configuration"
    echo -e "\n"
	echo -e "screenblank -ab | --adjust_blank"
	echo -e "adjust Screen Blank time in minutes"
    echo -e "\n"
	echo -e "screenblank -alb | --adjust_ls_blank"
	echo -e "adjust LockScreen blank time in minutes"
    echo -e "\n"
	echo -e "screenblank -as | --adjust_suspend"
	echo -e "adjust Suspend time in minutes"
    echo -e "\n"
	echo -e "screenblank -al | --adjust_lock"
	echo -e "adjust Suspend time in minutes"
}

disable_xset_presets
set_default_conf && update_conf
. $conf

# Options
if [[ -z $1 ]]; then
	trap 'clean_exit' EXIT INT TERM SIGINT SIGTERM SIGTSTP
	if [[ $screenblank = on ]]; then
		notify-send "screenblank disabled"
		screenblank=off
	else
		notify-send "screenblank enabled"
		screenblank=on
	fi
	update_conf
elif [[ $# = 1 ]];then
	case "$1" in
		-ts | --toggle_suspend)
			if [[ $autosuspend = on ]]; then
				notify "AutoSuspend Disabled"
				autosuspend=off
			else
				notify "AutoSuspend Enabled"
				autosuspend=on
			fi
			update_conf
			;;
		-tl | --toggle_lock)
			if [[ $autolock == on ]]; then
				notify "AutoLock Disabled"
				autolock=off
			else
				notify "AutoLock Enabled"
				autolock=on
			fi
			update_conf
			;;
		-b | --blank)
			sleep 2
			xset dpms force off
			;;
		-l | --lock)
			ci3
			;;
		-s | --status)
			notify "$(status)"
			;;
		-h | --help)
			usage
			;;
		-r | --reset)
			rm $conf
			echo "conf reset"
			;;
		*)
			echo -e "(((invalid argument)))\n"
			usage
			exit 1
			;;
	esac
	exit 0
elif [[ $# = 2 ]];then
	[[ ! $2 =~ ^[.0-9]+$ ]] && {
	echo -e "(((invalid argument)))\n"
	usage
	exit 1;}
	case "$1" in
		-ab | --adjust_blank)
			if echo "$2 >= $suspend_time" | bc -l | grep -q 1; then
			echo "Can't be set higher than Suspend time"
			exit 1
			fi
			echo "Screen blank set at $2 mins"
			blank_time=$2
			;;
		-alb | --adjust_ls_blank)
			if echo "$2 >= $suspend_time" | bc -l | grep -q 1; then
			echo "Can't be set higher than Suspend time"
			exit 1
			fi
			echo "LockScreen blank set at $2 mins"
			blanklock_time=$2
			;;
		-al | --adjust_lock)
			if echo "$2 >= $suspend_time" | bc -l | grep -q 1; then
			echo "Can't be set higher than Suspend time"
			exit 1
			elif echo "$2 <= $blank_time" | bc -l | grep -q 1; then
			echo "Can't be set lower than Blank time"
			exit 1
			fi
			echo "AutoLock set at $2 mins"
			lock_time=$2
			;;
		-as | --adjust_suspend)
			echo "AutoSuspend set at $2 mins"
			suspend_time=$2
			;;
		*)
			echo -e "(((invalid argument)))\n"
			usage
			exit 1
			;;
	esac
	update_conf
	exit 0
else
	echo -e "(((invalid argument)))\n"
	usage
	exit 1
fi

while [[ $screenblank = on ]]; do
	read -t 2 <> <(:)
	idle_time="$(xprintidle)"
	echo $idle_time
	if [[ $(xset -q) = *"Monitor is Off"* ]]; then
		if_video && continue
		[[ $autolock = on ]] && \
		[[ "$idle_time" -ge "${timesms[2]}" ]] && ci3
		[[ $autosuspend = on ]] && {
			[[ "$idle_time" -ge "${timesms[3]}" ]] && {
				systemctl suspend && resetidle
				until [[ $(xset -q) = *"Monitor is On"* ]]; do
					xset dpms force on
				done
			}
		}
		continue
	fi
	[[ $(pidof i3lock) ]] && \
	[[ "$idle_time" -le "${timesms[1]}" ]] && continue
	while if_video; do
		echo "Video is playing"
		read -t 2 <> <(:)
		if_video || resetidle
		[[ $(pidof i3lock) ]] && break
		[[ $screenblank = off ]] && break
	done
	refresh_conf
	[[ "$idle_time" -le "${timesms[0]}" ]] && continue
	xset dpms force off
done
